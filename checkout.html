<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - TechHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script>tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] }, colors: { primary: { 50:'#eef2ff',100:'#e0e7ff',200:'#c7d2fe',300:'#a5b4fc',400:'#818cf8',500:'#6366f1',600:'#4f46e5',700:'#4338ca',800:'#3730a3',900:'#312e81' }, accent: { 50:'#fdf4ff',100:'#fae8ff',200:'#f5d0fe',300:'#f0abfc',400:'#e879f9',500:'#d946ef',600:'#c026d3',700:'#a21caf',800:'#86198f',900:'#701a75' } } } } }</script>
    <style>
        .gradient-text{background:linear-gradient(135deg,#6366f1,#d946ef);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
        .card-3d{perspective:1000px;}
        .card-inner{transition:transform 0.6s;transform-style:preserve-3d;position:relative;}
        .card-3d.flipped .card-inner{transform:rotateY(180deg);}
        .card-front,.card-back{backface-visibility:hidden;position:absolute;inset:0;border-radius:1rem;}
        .card-back{transform:rotateY(180deg);}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .processing-pulse{animation:pulse 1.5s ease-in-out infinite;}
    </style>
</head>
<body class="font-sans bg-gray-50 dark:bg-gray-950 text-gray-900 dark:text-gray-100 min-h-screen">
    <nav class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl fixed top-0 left-0 right-0 z-50 border-b border-gray-200/50 dark:border-gray-800/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-16">
            <a href="index.html" class="flex items-center gap-2 text-xl font-bold"><i class="fas fa-bolt text-primary-500"></i><span class="gradient-text">TechHub</span></a>
            <div class="flex items-center gap-4 text-sm">
                <span class="hidden sm:inline text-gray-400"><i class="fas fa-lock text-green-500 mr-1"></i> Secure Checkout</span>
                <a href="cart.html" class="text-gray-500 hover:text-primary-500 transition"><i class="fas fa-arrow-left mr-1"></i> Back to Cart</a>
            </div>
        </div>
    </nav>

    <!-- Processing Overlay -->
    <div id="processing-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden items-center justify-center">
        <div class="bg-white dark:bg-gray-900 rounded-2xl p-10 text-center shadow-2xl">
            <div class="w-16 h-16 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin mx-auto mb-4"></div>
            <h3 class="text-lg font-bold mb-1">Processing Payment</h3>
            <p class="text-sm text-gray-500 processing-pulse">Please do not close this page...</p>
        </div>
    </div>

    <div class="pt-24 pb-16 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 class="text-2xl sm:text-3xl font-bold mb-8"><i class="fas fa-credit-card text-primary-500 mr-2"></i>Checkout</h1>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Left: Forms -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Shipping Info -->
                <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-100 dark:border-gray-800 p-6">
                    <h2 class="font-bold text-lg mb-4 flex items-center gap-2"><i class="fas fa-truck text-primary-500"></i> Shipping Information</h2>
                    <div class="grid sm:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium mb-1">First Name</label><input type="text" id="firstName" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm outline-none focus:ring-2 focus:ring-primary-500" required></div>
                        <div><label class="block text-sm font-medium mb-1">Last Name</label><input type="text" id="lastName" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm outline-none focus:ring-2 focus:ring-primary-500" required></div>
                        <div><label class="block text-sm font-medium mb-1">Email</label><input type="email" id="email" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm outline-none focus:ring-2 focus:ring-primary-500" required></div>
                        <div><label class="block text-sm font-medium mb-1">Phone</label><input type="tel" id="phone" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm outline-none focus:ring-2 focus:ring-primary-500" required></div>
                        <div class="sm:col-span-2"><label class="block text-sm font-medium mb-1">Address</label><input type="text" id="address" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm outline-none focus:ring-2 focus:ring-primary-500" required></div>
                        <div><label class="block text-sm font-medium mb-1">City</label><input type="text" id="city" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm outline-none focus:ring-2 focus:ring-primary-500" required></div>
                        <div><label class="block text-sm font-medium mb-1">State</label><input type="text" id="state" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm outline-none focus:ring-2 focus:ring-primary-500"></div>
                        <div><label class="block text-sm font-medium mb-1">Zip Code</label><input type="text" id="zipCode" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm outline-none focus:ring-2 focus:ring-primary-500" required></div>
                        <div><label class="block text-sm font-medium mb-1">Country</label><input type="text" id="country" value="US" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm outline-none focus:ring-2 focus:ring-primary-500"></div>
                    </div>
                </div>

                <!-- Payment -->
                <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-100 dark:border-gray-800 p-6">
                    <h2 class="font-bold text-lg mb-4 flex items-center gap-2"><i class="fas fa-credit-card text-primary-500"></i> Payment Method</h2>
                    <div class="grid grid-cols-3 gap-3 mb-6">
                        <button onclick="selectPayment('card')" class="payment-method active border-2 border-primary-500 bg-primary-50 dark:bg-primary-900/20 rounded-xl p-3 text-center transition hover:shadow"><i class="fab fa-cc-visa text-2xl text-primary-500"></i><div class="text-xs font-medium mt-1">Credit Card</div></button>
                        <button onclick="selectPayment('paypal')" class="payment-method border-2 border-gray-200 dark:border-gray-700 rounded-xl p-3 text-center transition hover:shadow"><i class="fab fa-paypal text-2xl text-blue-500"></i><div class="text-xs font-medium mt-1">PayPal</div></button>
                        <button onclick="selectPayment('cod')" class="payment-method border-2 border-gray-200 dark:border-gray-700 rounded-xl p-3 text-center transition hover:shadow"><i class="fas fa-money-bill-wave text-2xl text-green-500"></i><div class="text-xs font-medium mt-1">Cash</div></button>
                    </div>

                    <div id="card-inputs">
                        <!-- 3D Credit Card Preview -->
                        <div class="card-3d w-full max-w-sm mx-auto h-52 mb-6 cursor-pointer" id="credit-card">
                            <div class="card-inner w-full h-full">
                                <div class="card-front bg-gradient-to-br from-primary-600 via-primary-700 to-accent-600 rounded-2xl p-6 text-white shadow-xl">
                                    <div class="flex justify-between items-start mb-8">
                                        <i class="fas fa-sim-card text-3xl text-yellow-300/80"></i>
                                        <span id="card-logo" class="text-3xl"><i class="fab fa-cc-visa"></i></span>
                                    </div>
                                    <div id="card-number-display" class="text-xl sm:text-2xl font-mono tracking-wider mb-6">•••• •••• •••• ••••</div>
                                    <div class="flex justify-between items-end">
                                        <div><div class="text-[10px] uppercase text-white/60">Card Holder</div><div id="card-holder-display" class="text-sm font-medium tracking-wide">YOUR NAME</div></div>
                                        <div><div class="text-[10px] uppercase text-white/60">Expires</div><div id="card-expiry-display" class="text-sm font-medium">MM/YY</div></div>
                                        <span id="card-type-icon" class="text-2xl"><i class="fab fa-cc-visa"></i></span>
                                    </div>
                                </div>
                                <div class="card-back bg-gradient-to-br from-gray-700 to-gray-900 rounded-2xl text-white shadow-xl">
                                    <div class="w-full h-12 bg-black/40 mt-8"></div>
                                    <div class="px-6 mt-4"><div class="bg-gray-200 rounded h-10 flex items-center justify-end px-4"><span id="cvv-display" class="text-gray-800 font-mono font-bold">•••</span></div></div>
                                    <div class="px-6 mt-4 text-xs text-gray-400">This card is property of TechHub Bank. Unauthorized use is prohibited.</div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div><label class="block text-sm font-medium mb-1">Card Number</label><input type="text" id="cardNumber" maxlength="19" placeholder="1234 5678 9012 3456" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm outline-none focus:ring-2 focus:ring-primary-500 font-mono"></div>
                            <div><label class="block text-sm font-medium mb-1">Name on Card</label><input type="text" id="cardName" placeholder="JOHN DOE" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm outline-none focus:ring-2 focus:ring-primary-500 uppercase"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium mb-1">Expiry</label><input type="text" id="expiry" maxlength="5" placeholder="MM/YY" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm outline-none focus:ring-2 focus:ring-primary-500 font-mono"></div>
                                <div><label class="block text-sm font-medium mb-1">CVV</label><input type="text" id="cvv" maxlength="4" placeholder="•••" class="w-full px-4 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm outline-none focus:ring-2 focus:ring-primary-500 font-mono"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Order Summary -->
            <div>
                <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-100 dark:border-gray-800 p-6 shadow-sm sticky top-24">
                    <h3 class="font-bold text-lg mb-4">Order Summary</h3>
                    <div id="order-items" class="space-y-3 mb-4 max-h-64 overflow-y-auto"></div>
                    <div class="space-y-2 text-sm border-t border-gray-100 dark:border-gray-800 pt-4">
                        <div class="flex justify-between"><span class="text-gray-500">Subtotal</span><span id="subtotal">$0.00</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Tax (10%)</span><span id="tax">$0.00</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Shipping</span><span class="text-green-600">Free</span></div>
                        <hr class="border-gray-100 dark:border-gray-800">
                        <div class="flex justify-between text-lg font-bold"><span>Total</span><span id="total" class="text-primary-600">$0.00</span></div>
                    </div>
                    <button onclick="placeOrder()" class="w-full mt-6 bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3.5 rounded-xl transition flex items-center justify-center gap-2 shadow-lg shadow-primary-600/20">
                        <i class="fas fa-lock"></i> Place Order
                    </button>
                    <div class="flex items-center justify-center gap-3 mt-4 text-gray-400">
                        <i class="fab fa-cc-visa text-lg"></i><i class="fab fa-cc-mastercard text-lg"></i><i class="fab fa-cc-amex text-lg"></i><i class="fas fa-shield-alt text-lg text-green-500"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="script.js"></script>
    <script>
        let cartItems = [];
        let selectedPayment = 'card';
        const cardPatterns = { visa: /^4/, mastercard: /^5[1-5]|^2[2-7]/, amex: /^3[47]/, discover: /^6(?:011|5)/ };

        async function loadCheckout() {
            const token = localStorage.getItem('token');
            if (!token) { window.location.href = 'login.html'; return; }
            const user = JSON.parse(localStorage.getItem('current_user') || localStorage.getItem('user') || '{}');
            if (user.name) { const names = user.name.split(' '); document.getElementById('firstName').value = names[0] || ''; document.getElementById('lastName').value = names.slice(1).join(' ') || ''; }
            if (user.email) document.getElementById('email').value = user.email;

            const localCart = JSON.parse(localStorage.getItem('cart') || '[]');
            if (localCart.length > 0) { cartItems = localCart; renderOrderSummary(); }
            else {
                try { const response = await fetch(`${API_URL}/cart`, { headers: { 'Authorization': `Bearer ${token}` } }); if (response.ok) cartItems = await response.json(); } catch (e) {}
                if (cartItems.length === 0) { alert('Your cart is empty.'); window.location.href = 'index.html'; return; }
                renderOrderSummary();
            }
            initCardInputs();
        }

        function initCardInputs() {
            document.getElementById('cardNumber')?.addEventListener('input', function(e) {
                let v = e.target.value.replace(/\D/g, ''); v = v.replace(/(.{4})/g, '$1 ').trim(); e.target.value = v;
                updateCardDisplay(); detectCardType(v.replace(/\s/g, ''));
            });
            document.getElementById('cardName')?.addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
                document.getElementById('card-holder-display').textContent = e.target.value || 'YOUR NAME';
            });
            document.getElementById('expiry')?.addEventListener('input', function(e) {
                let v = e.target.value.replace(/\D/g, ''); if (v.length >= 2) v = v.slice(0,2) + '/' + v.slice(2); e.target.value = v;
                document.getElementById('card-expiry-display').textContent = v || 'MM/YY';
            });
            document.getElementById('cvv')?.addEventListener('focus', () => document.getElementById('credit-card').classList.add('flipped'));
            document.getElementById('cvv')?.addEventListener('blur', () => document.getElementById('credit-card').classList.remove('flipped'));
            document.getElementById('cvv')?.addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '');
                document.getElementById('cvv-display').textContent = e.target.value || '•••';
            });
        }

        function updateCardDisplay() {
            const v = document.getElementById('cardNumber').value;
            document.getElementById('card-number-display').textContent = v || '•••• •••• •••• ••••';
        }

        function detectCardType(number) {
            let type = null;
            for (const [t, p] of Object.entries(cardPatterns)) { if (p.test(number)) { type = t; break; } }
            const logoEl = document.getElementById('card-logo');
            const typeIcon = document.getElementById('card-type-icon');
            if (type) { logoEl.innerHTML = `<i class="fab fa-cc-${type}"></i>`; typeIcon.innerHTML = `<i class="fab fa-cc-${type}"></i>`; }
            else { logoEl.innerHTML = `<i class="fab fa-cc-visa"></i>`; typeIcon.innerHTML = `<i class="fab fa-cc-visa"></i>`; }
        }

        function renderOrderSummary() {
            const container = document.getElementById('order-items');
            let subtotal = 0;
            container.innerHTML = cartItems.map(item => {
                const t = item.price * item.quantity; subtotal += t;
                return `<div class="flex items-center gap-3 py-2">
                    <div class="w-12 h-12 bg-gray-100 dark:bg-gray-800 rounded-lg flex items-center justify-center flex-shrink-0">
                        <img src="${item.image_url || item.image || 'https://via.placeholder.com/48'}" alt="${item.name}" class="max-w-full max-h-full object-contain rounded">
                    </div>
                    <div class="flex-1 min-w-0"><h4 class="text-sm font-medium truncate">${item.name}</h4><span class="text-xs text-gray-400">Qty: ${item.quantity}</span></div>
                    <span class="text-sm font-bold">$${t.toFixed(2)}</span></div>`;
            }).join('');
            const tax = subtotal * 0.1; const total = subtotal + tax;
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('tax').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('total').textContent = `$${total.toFixed(2)}`;
        }

        function selectPayment(method) {
            selectedPayment = method;
            document.querySelectorAll('.payment-method').forEach(el => { el.classList.remove('active', 'border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20'); el.classList.add('border-gray-200', 'dark:border-gray-700'); });
            event.currentTarget.classList.add('active', 'border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20');
            event.currentTarget.classList.remove('border-gray-200', 'dark:border-gray-700');
            document.getElementById('card-inputs').style.display = method === 'card' ? 'block' : 'none';
        }

        function validateCard() {
            if (selectedPayment !== 'card') return true;
            const cn = document.getElementById('cardNumber').value.replace(/\s/g, '');
            if (cn.length < 15) { showNotification('Please enter a valid card number', 'error'); return false; }
            if (!document.getElementById('cardName').value.trim()) { showNotification('Please enter the name on card', 'error'); return false; }
            if (!/^\d{2}\/\d{2}$/.test(document.getElementById('expiry').value)) { showNotification('Please enter a valid expiry date', 'error'); return false; }
            if (document.getElementById('cvv').value.length < 3) { showNotification('Please enter a valid CVV', 'error'); return false; }
            return true;
        }

        async function placeOrder() {
            const token = localStorage.getItem('token');
            const required = ['firstName','lastName','email','phone','address','city','zipCode'];
            for (const f of required) { if (!document.getElementById(f).value.trim()) { showNotification(`Please fill in ${f.replace(/([A-Z])/g,' $1').toLowerCase()}`,'error'); document.getElementById(f).focus(); return; } }
            if (selectedPayment === 'card' && !validateCard()) return;

            document.getElementById('processing-overlay').classList.remove('hidden');
            document.getElementById('processing-overlay').classList.add('flex');

            let subtotal = cartItems.reduce((s,i) => s + i.price * i.quantity, 0);
            const tax = subtotal * 0.1; const total = subtotal + tax;
            await new Promise(r => setTimeout(r, 1500));

            document.getElementById('processing-overlay').classList.add('hidden');
            document.getElementById('processing-overlay').classList.remove('flex');
            localStorage.removeItem('cart');
            showOrderSuccessModal(total);

            try {
                fetch(`${API_URL}/orders`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ items: cartItems.map(i => ({ productId: i.product_id || i.id, quantity: i.quantity, price: i.price })), totalAmount: total, taxAmount: tax,
                        shippingAddress: { firstName: document.getElementById('firstName').value, lastName: document.getElementById('lastName').value, address: document.getElementById('address').value, city: document.getElementById('city').value, state: document.getElementById('state').value, zipCode: document.getElementById('zipCode').value, country: document.getElementById('country').value, phone: document.getElementById('phone').value }, paymentMethod: selectedPayment })
                }).catch(e => console.log('Background order save:', e));
            } catch(e) {}
        }

        function showOrderSuccessModal(total) {
            const m = document.createElement('div');
            m.className = 'fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[200] p-4';
            m.innerHTML = `
                <div class="bg-white dark:bg-gray-900 rounded-2xl p-8 sm:p-10 text-center max-w-md w-full shadow-2xl">
                    <div class="w-20 h-20 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-check text-4xl text-green-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">Order Placed Successfully!</h2>
                    <p class="text-gray-500 mb-2">Thank you for your purchase!</p>
                    <p class="text-sm text-gray-400 mb-6">Total: <span class="font-bold text-primary-600">$${total.toFixed(2)}</span></p>
                    <p class="text-xs text-gray-400 mb-6">A confirmation email has been sent.</p>
                    <div class="flex gap-3">
                        <button onclick="window.location.href='my-orders.html'" class="flex-1 bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 rounded-xl transition">View Orders</button>
                        <button onclick="window.location.href='index.html'" class="flex-1 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 font-semibold py-3 rounded-xl transition">Continue Shopping</button>
                    </div>
                </div>`;
            document.body.appendChild(m);
        }

        function showNotification(message, type) {
            const n = document.createElement('div');
            n.className = `fixed top-20 right-4 z-50 px-5 py-3 rounded-xl shadow-lg text-white text-sm font-medium flex items-center gap-2 ${type==='success'?'bg-green-500':'bg-red-500'}`;
            n.innerHTML = `<i class="fas fa-${type==='success'?'check':'times'}-circle"></i> ${message}`;
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 3000);
        }

        loadCheckout();
    </script>
</body>
</html>
