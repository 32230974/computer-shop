<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Offers - TechHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { 50:'#fff7ed',100:'#ffedd5',200:'#fed7aa',300:'#fdba74',400:'#fb923c',500:'#f97316',600:'#ea580c',700:'#c2410c',800:'#9a3412',900:'#7c2d12',950:'#431407' },
                        accent: { 50:'#fef2f2',100:'#fee2e2',200:'#fecaca',300:'#fca5a5',400:'#f87171',500:'#ef4444',600:'#dc2626',700:'#b91c1c',800:'#991b1b',900:'#7f1d1d' }
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 dark:bg-gray-950 text-gray-900 dark:text-gray-100 font-sans min-h-screen">

    <!-- Top Nav -->
    <nav class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-lg border-b border-gray-200 dark:border-gray-800 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="admin-dashboard.html" class="text-gray-500 hover:text-primary-500 transition-colors"><i class="fas fa-arrow-left"></i></a>
                <h1 class="text-lg font-bold">Manage Offers</h1>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="openModal()" class="px-4 py-2 bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white text-sm font-medium rounded-xl shadow-lg shadow-primary-500/25 transition-all flex items-center gap-2">
                    <i class="fas fa-plus"></i> <span class="hidden sm:inline">New Offer</span>
                </button>
                <button onclick="toggleDarkMode()" class="w-9 h-9 flex items-center justify-center rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-moon dark:hidden text-sm"></i><i class="fas fa-sun hidden dark:inline text-sm"></i>
                </button>
                <button onclick="adminLogout()" class="px-4 py-2 text-sm font-medium text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-colors">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-6 lg:py-8">
        <!-- Stats -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white dark:bg-gray-900 rounded-2xl p-5 border border-gray-200 dark:border-gray-800">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-primary-100 dark:bg-primary-900/30 rounded-xl flex items-center justify-center">
                        <i class="fas fa-tags text-primary-500"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">Total Offers</p>
                        <p id="stat-total" class="text-xl font-bold">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-900 rounded-2xl p-5 border border-gray-200 dark:border-gray-800">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-xl flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">Active</p>
                        <p id="stat-active" class="text-xl font-bold">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-900 rounded-2xl p-5 border border-gray-200 dark:border-gray-800">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-amber-100 dark:bg-amber-900/30 rounded-xl flex items-center justify-center">
                        <i class="fas fa-percent text-amber-500"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">Avg Discount</p>
                        <p id="stat-avg-discount" class="text-xl font-bold">0%</p>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-900 rounded-2xl p-5 border border-gray-200 dark:border-gray-800">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-accent-100 dark:bg-accent-900/30 rounded-xl flex items-center justify-center">
                        <i class="fas fa-dollar-sign text-accent-500"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">Total Savings</p>
                        <p id="stat-savings" class="text-xl font-bold">$0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Offers Table -->
        <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50 dark:bg-gray-800/50 border-b border-gray-200 dark:border-gray-700">
                            <th class="px-6 py-4 text-left font-semibold text-gray-600 dark:text-gray-300">Product</th>
                            <th class="px-6 py-4 text-left font-semibold text-gray-600 dark:text-gray-300">Original</th>
                            <th class="px-6 py-4 text-left font-semibold text-gray-600 dark:text-gray-300">Offer Price</th>
                            <th class="px-6 py-4 text-left font-semibold text-gray-600 dark:text-gray-300 hidden md:table-cell">Discount</th>
                            <th class="px-6 py-4 text-left font-semibold text-gray-600 dark:text-gray-300">Status</th>
                            <th class="px-6 py-4 text-left font-semibold text-gray-600 dark:text-gray-300">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="offers-tbody" class="divide-y divide-gray-100 dark:divide-gray-800">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Offer Modal -->
    <div id="offer-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="absolute inset-4 lg:inset-auto lg:top-1/2 lg:left-1/2 lg:-translate-x-1/2 lg:-translate-y-1/2 lg:w-full lg:max-w-lg bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 id="modal-title" class="text-xl font-bold">Create Offer</h2>
                    <button onclick="closeModal()" class="w-9 h-9 flex items-center justify-center rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="offer-form" class="space-y-4">
                    <input type="hidden" id="offer-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Product</label>
                        <select id="product-id" required class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                            <option value="">Select Product</option>
                        </select>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-4">
                        <p class="text-xs text-gray-500 mb-1">Original Price</p>
                        <p id="original-price-display" class="text-lg font-bold text-gray-900 dark:text-gray-100">$0.00</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Discount %</label>
                            <input type="number" id="discount-percent" min="1" max="99" class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="e.g. 20">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Offer Price ($)</label>
                            <input type="number" id="offer-price" step="0.01" class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="Auto-calculated">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description</label>
                        <textarea id="offer-description" rows="3" class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none" placeholder="Optional"></textarea>
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button type="submit" class="flex-1 py-3 bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white font-medium rounded-xl shadow-lg shadow-primary-500/25 transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-save"></i> Save Offer
                        </button>
                        <button type="button" onclick="closeModal()" class="px-6 py-3 bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-medium rounded-xl hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="fixed top-20 right-4 z-50 hidden px-6 py-4 rounded-xl shadow-2xl text-white flex items-center gap-3"></div>

    <script src="config.js"></script>
    <script>
        const API_URL = window.location.origin + '/api';
        let products = [];
        let offers = [];

        function checkAdminAuth() {
            const admin = localStorage.getItem('current_admin');
            if (!admin) { window.location.href = 'admin-login.html'; }
        }

        async function loadProducts() {
            try {
                const response = await fetch(`${API_URL}/products`);
                if (response.ok) { products = await response.json(); }
                else { loadDemoProducts(); }
            } catch { loadDemoProducts(); }
            populateProductDropdown();
        }

        function loadDemoProducts() {
            products = JSON.parse(localStorage.getItem('techhub_products') || '[]');
            if (products.length === 0) {
                products = [
                    { id: 1, name: 'MacBook Pro 14" M4 Pro', price: 1999, image: 'üíª' },
                    { id: 2, name: 'Dell XPS 13', price: 1299, image: 'üíª' },
                    { id: 3, name: 'Gaming Laptop - RTX 4070', price: 1599, image: 'üéÆ' },
                    { id: 4, name: 'Desktop PC - Intel i9', price: 2499, image: 'üñ•Ô∏è' },
                    { id: 5, name: 'Wireless Mouse', price: 29, image: 'üñ±Ô∏è' },
                    { id: 6, name: 'Mechanical Keyboard', price: 89, image: '‚å®Ô∏è' },
                    { id: 7, name: 'Wireless Headphones', price: 149, image: 'üéß' },
                    { id: 8, name: 'USB-C Hub', price: 49, image: 'üîå' }
                ];
            }
        }

        function populateProductDropdown() {
            const select = document.getElementById('product-id');
            select.innerHTML = '<option value="">Select Product</option>';
            products.forEach(p => {
                select.innerHTML += `<option value="${p.id}" data-price="${p.price}">${p.image || 'üì¶'} ${p.name} - $${p.price.toFixed(2)}</option>`;
            });
        }

        async function loadOffers() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/offers`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (response.ok) { offers = await response.json(); }
                else { offers = JSON.parse(localStorage.getItem('techhub_offers') || '[]'); }
            } catch { offers = JSON.parse(localStorage.getItem('techhub_offers') || '[]'); }
            renderOffers();
            updateStats();
        }

        function renderOffers() {
            const tbody = document.getElementById('offers-tbody');
            if (offers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500"><i class="fas fa-tags text-3xl mb-2 block"></i>No offers yet. Click "New Offer" to create one.</td></tr>';
                return;
            }
            tbody.innerHTML = offers.map(o => {
                const product = products.find(p => p.id == o.product_id || p.id == o.productId) || {};
                const discount = o.discount_percent || o.discountPercent || 0;
                return `<tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${product.image || o.image || 'üì¶'}</span>
                            <span class="font-medium">${product.name || o.product_name || o.productName || 'Product'}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-gray-500 line-through">$${(o.original_price || o.originalPrice || product.price || 0).toFixed(2)}</td>
                    <td class="px-6 py-4 font-bold text-green-600 dark:text-green-400">$${(o.offer_price || o.offerPrice || 0).toFixed(2)}</td>
                    <td class="px-6 py-4 hidden md:table-cell"><span class="px-2.5 py-1 text-xs font-bold bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-full">-${discount}%</span></td>
                    <td class="px-6 py-4">
                        <span class="px-2.5 py-1 text-xs font-medium rounded-full ${o.active !== false ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300' : 'bg-gray-100 dark:bg-gray-800 text-gray-500'}">${o.active !== false ? 'Active' : 'Inactive'}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex gap-1.5">
                            <button onclick="editOffer(${o.id})" class="px-2.5 py-1.5 text-xs bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 rounded-lg hover:bg-primary-200 dark:hover:bg-primary-900/50 transition-colors" title="Edit"><i class="fas fa-edit"></i></button>
                            <button onclick="toggleOffer(${o.id})" class="px-2.5 py-1.5 text-xs bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 rounded-lg hover:bg-amber-200 dark:hover:bg-amber-900/50 transition-colors" title="Toggle"><i class="fas fa-power-off"></i></button>
                            <button onclick="deleteOffer(${o.id})" class="px-2.5 py-1.5 text-xs bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-lg hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function updateStats() {
            const activeOffers = offers.filter(o => o.active !== false);
            document.getElementById('stat-total').textContent = offers.length;
            document.getElementById('stat-active').textContent = activeOffers.length;
            const avgDiscount = activeOffers.length > 0 ? Math.round(activeOffers.reduce((s, o) => s + (o.discount_percent || o.discountPercent || 0), 0) / activeOffers.length) : 0;
            document.getElementById('stat-avg-discount').textContent = avgDiscount + '%';
            const totalSavings = activeOffers.reduce((s, o) => s + ((o.original_price || o.originalPrice || 0) - (o.offer_price || o.offerPrice || 0)), 0);
            document.getElementById('stat-savings').textContent = '$' + totalSavings.toFixed(0);
        }

        function openModal(offer = null) {
            document.getElementById('modal-title').textContent = offer ? 'Edit Offer' : 'Create Offer';
            document.getElementById('offer-id').value = offer ? offer.id : '';
            document.getElementById('product-id').value = offer ? (offer.product_id || offer.productId || '') : '';
            document.getElementById('discount-percent').value = offer ? (offer.discount_percent || offer.discountPercent || '') : '';
            document.getElementById('offer-price').value = offer ? (offer.offer_price || offer.offerPrice || '') : '';
            document.getElementById('offer-description').value = offer ? (offer.description || '') : '';
            updateOriginalPriceDisplay();
            document.getElementById('offer-modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('offer-modal').classList.add('hidden'); }

        function editOffer(id) {
            const offer = offers.find(o => o.id === id);
            if (offer) openModal(offer);
        }

        function updateOriginalPriceDisplay() {
            const select = document.getElementById('product-id');
            const option = select.options[select.selectedIndex];
            const price = option ? parseFloat(option.dataset.price) || 0 : 0;
            document.getElementById('original-price-display').textContent = '$' + price.toFixed(2);
        }

        async function saveOffer(e) {
            e.preventDefault();
            const productId = parseInt(document.getElementById('product-id').value);
            const discountPercent = parseFloat(document.getElementById('discount-percent').value);
            const offerPrice = parseFloat(document.getElementById('offer-price').value);
            const description = document.getElementById('offer-description').value;
            const offerId = document.getElementById('offer-id').value;

            if (!productId) { showNotification('Please select a product', 'error'); return; }
            if (!discountPercent && !offerPrice) { showNotification('Enter discount % or offer price', 'error'); return; }

            const product = products.find(p => p.id === productId);
            if (!product) { showNotification('Product not found', 'error'); return; }

            const finalOfferPrice = offerPrice || calculateOfferPrice(product.price, discountPercent);
            const finalDiscount = discountPercent || calculateDiscountPercent(product.price, offerPrice);

            const offerData = {
                id: offerId ? parseInt(offerId) : Date.now(),
                product_id: productId,
                productId: productId,
                product_name: product.name,
                productName: product.name,
                image: product.image,
                original_price: product.price,
                originalPrice: product.price,
                offer_price: finalOfferPrice,
                offerPrice: finalOfferPrice,
                discount_percent: finalDiscount,
                discountPercent: finalDiscount,
                description: description,
                active: true,
                createdAt: new Date().toISOString()
            };

            try {
                const token = localStorage.getItem('token');
                const method = offerId ? 'PUT' : 'POST';
                const url = offerId ? `${API_URL}/offers/${offerId}` : `${API_URL}/offers`;
                const response = await fetch(url, {
                    method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(offerData)
                });
                if (response.ok) {
                    closeModal();
                    await loadOffers();
                    showNotification(offerId ? 'Offer updated!' : 'Offer created!', 'success');
                    return;
                }
            } catch { console.log('Backend not available, using localStorage'); }

            // localStorage fallback
            if (offerId) {
                const idx = offers.findIndex(o => o.id === parseInt(offerId));
                if (idx !== -1) offers[idx] = offerData;
            } else {
                offers.push(offerData);
            }
            localStorage.setItem('techhub_offers', JSON.stringify(offers));
            closeModal();
            renderOffers();
            updateStats();
            showNotification(offerId ? 'Offer updated!' : 'Offer created!', 'success');
        }

        async function toggleOffer(id) {
            const offer = offers.find(o => o.id === id);
            if (!offer) return;
            offer.active = !offer.active;
            try {
                const token = localStorage.getItem('token');
                await fetch(`${API_URL}/offers/${id}`, {
                    method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ active: offer.active })
                });
            } catch {}
            localStorage.setItem('techhub_offers', JSON.stringify(offers));
            renderOffers();
            updateStats();
            showNotification(`Offer ${offer.active ? 'activated' : 'deactivated'}`, 'success');
        }

        async function deleteOffer(id) {
            if (!confirm('Delete this offer?')) return;
            try {
                const token = localStorage.getItem('token');
                await fetch(`${API_URL}/offers/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
            } catch {}
            offers = offers.filter(o => o.id !== id);
            localStorage.setItem('techhub_offers', JSON.stringify(offers));
            renderOffers();
            updateStats();
            showNotification('Offer deleted', 'success');
        }

        function calculateOfferPrice(originalPrice, discountPercent) {
            return parseFloat((originalPrice * (1 - discountPercent / 100)).toFixed(2));
        }

        function calculateDiscountPercent(originalPrice, offerPrice) {
            return parseFloat(((1 - offerPrice / originalPrice) * 100).toFixed(1));
        }

        // Auto-calculation listeners
        document.getElementById('product-id').addEventListener('change', function() {
            updateOriginalPriceDisplay();
            const discount = document.getElementById('discount-percent').value;
            if (discount) {
                const option = this.options[this.selectedIndex];
                const price = parseFloat(option.dataset.price) || 0;
                document.getElementById('offer-price').value = calculateOfferPrice(price, parseFloat(discount));
            }
        });

        document.getElementById('discount-percent').addEventListener('input', function() {
            const select = document.getElementById('product-id');
            const option = select.options[select.selectedIndex];
            const price = parseFloat(option?.dataset?.price) || 0;
            if (price && this.value) {
                document.getElementById('offer-price').value = calculateOfferPrice(price, parseFloat(this.value));
            }
        });

        document.getElementById('offer-price').addEventListener('input', function() {
            const select = document.getElementById('product-id');
            const option = select.options[select.selectedIndex];
            const price = parseFloat(option?.dataset?.price) || 0;
            if (price && this.value) {
                document.getElementById('discount-percent').value = calculateDiscountPercent(price, parseFloat(this.value));
            }
        });

        document.getElementById('offer-form').addEventListener('submit', saveOffer);

        function showNotification(message, type) {
            const n = document.getElementById('notification');
            n.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
            n.className = `fixed top-20 right-4 z-50 px-6 py-4 rounded-xl shadow-2xl text-white flex items-center gap-3 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            setTimeout(() => { n.classList.add('hidden'); }, 3000);
        }

        function adminLogout() { localStorage.removeItem('current_admin'); window.location.href = 'admin-login.html'; }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', document.documentElement.classList.contains('dark').toString());
        }
        if (localStorage.getItem('darkMode') === 'true') document.documentElement.classList.add('dark');

        checkAdminAuth();
        loadProducts().then(() => loadOffers());
    </script>
</body>
</html>
